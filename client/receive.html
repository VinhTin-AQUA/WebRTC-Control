<!DOCTYPE html>
<html>
	<head>
		<title>WebRTC Screen Share</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
	</head>
	<body>
		<button id="btnView" onclick="startViewer()">View Screen</button>

		<h3>Remote (Screen you're viewing):</h3>
		<video id="remoteVideo" autoplay playsinline muted  style="max-width: 100%"></video>

		<script>
			let connection = null;
			let peerConnection = null;
			let localStream = null;
			let isSharing = false;
			let hasStarted = false;

			async function ensureConnection() {
				if (!connection) {
					connection = new signalR.HubConnectionBuilder()
						.withUrl('https://localhost:7072/screensharehub')
						.build();

					connection.on('ReceiveSignal', async (user, data) => {
						await handleSignal(data);
					});

					await connection.start().catch(err => console.error('Connection failed:', err));
				} else if (connection.state !== signalR.HubConnectionState.Connected) {
					await connection.start().catch(err => console.error('Connection failed:', err));
				}
			}

			async function createPeer() {
				if (peerConnection) return;

				peerConnection = new RTCPeerConnection();

				peerConnection.onicecandidate = event => {
					if (event.candidate) {
						connection.invoke('SendSignal', '', event.candidate);
					}
				};

				peerConnection.ontrack = event => {
					document.getElementById('remoteVideo').srcObject = event.streams[0];
				};
			}

			async function startViewer() {
				await ensureConnection();
				await createPeer();

				if (!hasStarted) {
					// Send dummy "viewer ready" signal
					await connection.invoke('SendSignal', '', { type: 'viewer-ready' });
					hasStarted = true;
				}
			}

			async function handleSignal(data) {
				if (!peerConnection) await createPeer();

				if (data.type === 'offer') {
					await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
					const answer = await peerConnection.createAnswer();
					await peerConnection.setLocalDescription(answer);
					await connection.invoke('SendSignal', '', answer);
				} else if (data.type === 'answer') {
					await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
				} else if (data.candidate) {
					await peerConnection.addIceCandidate(new RTCIceCandidate(data));
				} else if (data.type === 'viewer-ready' && isSharing) {
					// Viewer is ready, re-send offer
					const offer = await peerConnection.createOffer();
					await peerConnection.setLocalDescription(offer);
					await connection.invoke('SendSignal', '', offer);
				}
			}

			// GỌI KHI TRANG ĐÃ SẴN SÀNG
			window.addEventListener('DOMContentLoaded', () => {
				startViewer().then().catch(err => console.error('❌ Viewer error:', err));
                console.log(2);
			});
		</script>
	</body>
</html>
