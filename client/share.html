<!DOCTYPE html>
<html>
	<head>
		<title>Share Screen</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
	</head>
	<body>
		<button id="btnStartShare" onclick="startShare()">Start Screen Share</button>
		<button id="btnStopShare" onclick="stopShare()" disabled>Stop Screen Share</button>
		<button onclick="sendData()">Send</button>

		<script>
			let connection = null;
			let peerConnection = null;
			let localStream = null;
			let receivedChannel = null;

			const Status = Object.freeze({
				PENDING: Symbol('PENDING'),
				SUCCESS: Symbol('SUCCESS'),
				ERROR: Symbol('ERROR'),
			});

            

			async function ensureConnection() {
				if (!connection) {
					connection = new signalR.HubConnectionBuilder()
						.withUrl('https://localhost:7072/screensharehub')
						.build();

					connection.on('ReceiveSignal', async (user, data) => {
						await handleSignal(data);
					});

					await connection.start().catch(err => console.error('Connection failed:', err));
				} else if (connection.state !== signalR.HubConnectionState.Connected) {
					await connection.start().catch(err => console.error('Connection failed:', err));
				}
			}

			async function createPeer() {
				if (peerConnection) return;

				peerConnection = new RTCPeerConnection({
					iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
				});

				// Debug connection states
				peerConnection.oniceconnectionstatechange = () => {
					console.log('ICE Connection State:', peerConnection.iceConnectionState);
				};

				peerConnection.onconnectionstatechange = () => {
					console.log('Connection State:', peerConnection.connectionState);
				};

				peerConnection.onicecandidate = event => {
					if (event.candidate) {
						connection.invoke('SendSignal', '', event.candidate);
					}
				};

				peerConnection.ondatachannel = event => {
					console.log('DataChannel received!');
					receivedChannel = event.channel;

					receivedChannel.onopen = () => {
						console.log('DataChannel opened on Sharer side');
						receivedChannel.send('Hello from Sharer!');
					};

					receivedChannel.onmessage = event => {
						try {
							console.log(JSON.parse(event.data));
						} catch {
							console.log(event.data);
						}
					};

					receivedChannel.onclose = () => {
						console.log('DataChannel closed on Sharer side');
					};

					receivedChannel.onerror = error => {
						console.error('DataChannel error:', error);
					};
				};
			}

			async function startShare() {
				await ensureConnection();
				await createPeer();
				await sendData({ screenWidth: screen.width, screenHeight: screen.height });

				try {
					localStream = await navigator.mediaDevices.getDisplayMedia({
						video: true,
						audio: false,
					});

					localStream.getTracks().forEach(track => {
						peerConnection.addTrack(track, localStream);
					});

					const offer = await peerConnection.createOffer();
					await peerConnection.setLocalDescription(offer);
					await connection.invoke('SendSignal', '', offer);

					document.getElementById('btnStartShare').disabled = true;
					document.getElementById('btnStopShare').disabled = false;
				} catch (err) {
					console.error('Could not start screen share:', err);
				}
			}

			async function stopShare() {
				if (localStream) {
					localStream.getTracks().forEach(track => track.stop());
					localStream = null;
				}

				if (peerConnection) {
					peerConnection.close();
					peerConnection = null;
				}

				document.getElementById('btnStartShare').disabled = false;
				document.getElementById('btnStopShare').disabled = true;
			}

			async function handleSignal(data) {
				if (!peerConnection) await createPeer();

				if (data.type === 'offer') {
					await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
					const answer = await peerConnection.createAnswer();
					await peerConnection.setLocalDescription(answer);
					await connection.invoke('SendSignal', '', answer);
				} else if (data.candidate) {
					try {
						await peerConnection.addIceCandidate(new RTCIceCandidate(data));
					} catch (e) {
						console.error('Error adding ICE candidate:', e);
					}
				}
			}

			async function sendData(data) {
				receivedChannel.send(JSON.stringify(data));
			}

			window.addEventListener('DOMContentLoaded', () => {
				ensureConnection().catch(err => console.error('Connection error:', err));
			});
		</script>
	</body>
</html>
